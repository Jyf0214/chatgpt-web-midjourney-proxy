var te=Object.defineProperty;var se=(o,t,e)=>t in o?te(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var H=(o,t,e)=>(se(o,typeof t!="symbol"?t+"":t,e),e);import{ba as P,m as L,G as f,b1 as Y,aY as V,b9 as ae,d as M,r as S,o as u,c as p,a as s,O as G,a3 as N,I as T,a4 as m,_ as x,$ as g,J as n,a5 as C,b as v,W as E,X as le,u as oe,Y as $,l as A,Z as j,S as ne,b3 as F,a2 as ie,ab as K,aI as re,N as de,bf as ce,a1 as ue,aK as ve,aO as pe,aR as fe,b7 as me}from"./index-b574640b.js";import{a as J}from"./lumaStore-af1c3abe.js";import{N as ge}from"./ButtonGroup-eeb662e4.js";class Q{constructor(){H(this,"localKey","viggle-store")}save(t){if(!t.taskID)throw"taskID must";let e=this.getObjs(),c=e.findIndex(y=>y.taskID==t.taskID);return c>-1?e[c]=t:e.push(t),P.set(this.localKey,e),this}findIndex(t){return this.getObjs().findIndex(e=>e.taskID==t)}getObjs(){const t=P.get(this.localKey);return t||[]}getOneById(t){const e=this.findIndex(t);return e<0?null:this.getObjs()[e]}}function ye(){let o={};if(f.myData.vtoken){const e={"x-vtoken":f.myData.vtoken,"x-ctoken":f.myData.ctoken};o={...o,...e}}if(!V.myData.VIGGLE_KEY){const e=ae();if(e.token){const c={"x-ptoken":e.token};return o={...o,...c},o}return o}const t={Authorization:"Bearer "+V.myData.VIGGLE_KEY};return o={...o,...t},o}const _e=o=>{if(o.indexOf("http")==0)return o;const t=o.indexOf("/pro")>-1?"/pro":"";return o=o.replaceAll("/pro",""),V.myData.VIGGLE_SERVER?V.myData.VIGGLE_SERVER.indexOf("/pro")>0?`${V.myData.VIGGLE_SERVER}/viggle${o}`:`${V.myData.VIGGLE_SERVER}${t}/viggle${o}`:`${t}/viggle${o}`},R=(o,t,e)=>{L("viggleFetch",o);let c=e!=null&&e.upFile?{}:{"Content-Type":"application/json"};return e&&e.headers&&(c=e.headers),c={...c,...ye()},new Promise((y,D)=>{let r={method:"GET"};r.headers=c,e!=null&&e.upFile?(r.method="POST",r.body=t):t&&(r.body=JSON.stringify(t),r.method="POST"),fetch(_e(o),r).then(async i=>{var _;if(!i.ok){let h="发生错误: "+i.status;try{let I=await i.json();h="("+i.status+")发生错误: "+(((_=I==null?void 0:I.error)==null?void 0:_.message)??"")}catch{}throw f.myData.ms&&f.myData.ms.error(h),new Error(h)}i.json().then(h=>y(h)).catch(h=>{f.myData.ms&&f.myData.ms.error("发生错误"+h),D(h)})}).catch(i=>{i.name==="TypeError"&&i.message==="Failed to fetch"?f.myData.ms&&f.myData.ms.error("跨域|CORS error"):f.myData.ms&&f.myData.ms.error("发生错误:"+i),L("e",i.stat),D(i)})})};async function W(o){const t=new Q,c=new J().getOneById(o);for(let y=0;y<500;y++){let D="/video-task/by-ids";c&&c.isHK&&(D="/pro/video-task/by-ids");const r=await R(D,{ids:[o]});if(L("FeedViggleTask",r),r.data&&r.data.length>0){let i=r.data[0];if(i.last_feed=new Date().getTime(),t.save(i),f.setMyData({act:"FeedViggleTask"}),r.data[0].status==0)return}await Y(2e3)}}const he={class:"w-full h-full p-4"},ke={class:"flex items-center justify-start line-clamp-1 pb-4"},De=["onClick"],be={key:0,class:"grid grid-cols-1 gap-5 md:grid-cols-2 lg:grid-cols-3"},we={class:"mb-2"},Ie=["onMousemove"],$e={key:0,class:"absolute right-2 top-2 z-40"},xe={class:"absolute w-full h-full top-0 left-0 z-1"},Ce=["controls","poster","src"],Se={class:"line-clamp-1"},Ve=M({__name:"dcTemple",props:{q:null},emits:["close","toq"],setup(o,{emit:t}){const e=o,c=S({qindex:0}),y=S([]),D=S([]),r=async()=>{let k=await R("/template2/tag");L("tags",k),k.data&&(y.value=k.data,y.value.length>0&&_(y.value[0]))},i=()=>{r()},_=k=>{t("toq",{q:k.name}),h("",k.id)},h=async(k,z)=>{let b=`/template2?page=1&pageSize=48&searchKeyword=${encodeURIComponent(k)}&tagID=${z}&type=0`,w=await R(b);L("searchQ",w),D.value=[],w.data&&w.data.length>0&&(D.value=w.data)},I=k=>{L("useVideo",k),f.setMyData({act:"viggle.useVideo",actData:k})};return i(),(k,z)=>(u(),p("div",he,[s("div",ke,[(u(!0),p(G,null,N(y.value,b=>(u(),p("div",{class:"m-1 cursor-pointer",onClick:w=>_(b)},[b.name==e.q?(u(),T(n(C),{key:0,strong:"",round:"",size:"small",type:"success"},{default:m(()=>[x(g(b.name),1)]),_:2},1024)):(u(),T(n(C),{key:1,strong:"",secondary:"",round:"",size:"small",type:"success"},{default:m(()=>[x(g(b.name),1)]),_:2},1024))],8,De))),256))]),D.value.length>0?(u(),p("div",be,[(u(!0),p(G,null,N(D.value,(b,w)=>(u(),p("div",we,[s("div",{class:"relative h-[180px]",onMousemove:q=>c.value.qindex=w},[c.value.qindex==w?(u(),p("div",$e,[v(n(C),{rounded:"",size:"small",type:"success",onClick:q=>I(b)},{default:m(()=>[x(g(k.$t("dance.use")),1)]),_:2},1032,["onClick"])])):E("",!0),s("div",xe,[s("video",{controls:c.value.qindex==w,playsinline:"",loop:"",poster:b.processedCoverURL,class:"rounded-lg bg-[#242424] object-contain w-full h-full transition-all",src:b.processedURL},null,8,Ce)])],40,Ie),s("div",Se,g(b.description),1)]))),256))])):E("",!0)]))}});const Le={class:"p-2"},Re={class:"pt-2"},Ee={class:"pt-2 flex justify-center items-center w-full relative"},ze={key:0,class:"absolute right-1 top-3 z-40"},Oe={key:1,class:"text-center"},je={key:0,class:"pt-2"},Ge={class:"relative h-[180px]"},Te={class:"absolute right-1 top-1 z-40"},Me={class:"absolute w-full h-full top-0 left-0 z-1"},qe=["poster","src"],Ue={key:1,class:"pt-2"},Fe={class:"relative h-[180px]"},Ne={class:"absolute right-1 top-1 z-40"},Ke={class:"absolute w-full h-full top-0 left-0 z-1"},Be=["poster","src"],He={key:2,class:"pt-2 flex justify-center items-center w-full"},Pe={class:"h-[180px] w-full overflow-hidden rounded-sm border border-gray-400/20 flex justify-center items-center"},Ae={class:"text-center"},Ye={key:3,class:"pt-2"},Je={class:"pt-2 flex justify-center items-center w-full"},Qe=["innerHTML"],We={class:"flex justify-between items-center w-full"},Xe={class:"pr-4"},Ze={class:"max-w-[400px]"},et=M({__name:"dcInput",setup(o){const t=S({imageID:"",bgMode:2,modelInfoID:3,templateID:"",videoID:"",watermark:1}),e=S({isDo:!1,showImg:!1,q:"",imgSrc:"",vgSrc:"",vgCoverURL:"",version:"relax"}),c=S(),y=S(),D=S(),r=le(),{isMobile:i}=oe(),_=[{label:$("dance.model")+": V2",value:2},{label:$("dance.model")+": V2-Turbo",value:3}],h=[{label:$("dance.bgw"),value:0},{label:$("dance.bgg"),value:1},{label:$("dance.bgmoban"),value:2},{label:$("dance.bgrole"),value:3}],I=async()=>{r.loading($("dance.gring"));let a=await R(w("/video-task"),t.value);a.data&&a.data.taskID&&(e.value.version=="pro"&&(new J().save({id:a.data.taskID,isHK:!0}),await Y(800)),W(a.data.taskID))},k=()=>{},z=A(()=>(t.value.templateID||t.value.videoID)&&t.value.imageID),b=a=>{a==1?(c.value=void 0,t.value.templateID="",t.value.videoID=""):a==3?(c.value=void 0,t.value.templateID="",t.value.videoID="",e.value.vgSrc="",e.value.vgCoverURL=""):(t.value.imageID="",e.value.imgSrc="")};function w(a){return e.value.version=="pro"&&(a="/pro"+a),a}async function q(a){const l=new FormData;l.append("file",a.target.files[0]);let d=await R(w("/asset/video/"+t.value.imageID),l,{upFile:!0});L("d Video",d),d.data&&d.data.id&&(t.value.videoID=d.data.id,t.value.templateID="",e.value.vgCoverURL=d.data.coverURL,e.value.vgSrc=d.data.url)}const X=()=>{if(t.value.imageID==""){r.error($("dance.uprolefirst"));return}D.value.click()};async function Z(a){try{let l=await pe(a.target.files[0]);const d=new FormData;d.append("file",a.target.files[0]);let O=await R(w("/asset/image"),d,{upFile:!0});L("d Image",O),O.data&&O.data.id&&(t.value.imageID=O.data.id,e.value.imgSrc=l),y.value=""}catch{r.error($("dance.uprolefail"))}}const U=A(()=>{const a=V.myData.VIGGLE_SERVER.toLocaleLowerCase();return a!=""?a.indexOf("hk")>-1&&a.indexOf("pro")==-1:f.myData.session&&f.myData.session.isHk}),B=a=>{f.setMyData({is_viggle_pro:a}),V.setMyData({IS_VIGGLE_PRO:a})};j(()=>U.value,a=>B(a&&e.value.version=="pro")),j(()=>e.value.version,()=>B(U.value&&e.value.version=="pro")),j(()=>f.myData.act,a=>{a=="viggle.useVideo"&&(L("viggle.useVideo",f.myData.actData),c.value=f.myData.actData,e.value.showImg=!1,t.value.templateID=c.value.id,t.value.videoID="")});const ee=[{label:"版本: watermark, 价格实惠",value:"relax"},{label:"版本: pro, 无水印",value:"pro"}];return ne(()=>{f.setMyData({ms:r}),e.value.version=V.myData.IS_VIGGLE_PRO?"pro":"relax"}),(a,l)=>(u(),p(G,null,[s("div",Le,[s("div",null,[v(n(F),{value:t.value.modelInfoID,"onUpdate:value":l[0]||(l[0]=d=>t.value.modelInfoID=d),options:_,size:"small"},null,8,["value"])]),s("div",Re,[v(n(F),{value:t.value.bgMode,"onUpdate:value":l[1]||(l[1]=d=>t.value.bgMode=d),options:h,size:"small"},null,8,["value"])]),s("div",Ee,[s("input",{type:"file",onChange:Z,ref_key:"fsRef",ref:y,style:{display:"none"},accept:"image/jpeg, image/jpg, image/png, image/gif"},null,544),e.value.imgSrc?(u(),p("div",ze,[v(n(C),{strong:"",secondary:"",round:"",size:"small",type:"success",onClick:l[2]||(l[2]=d=>b(2))},{default:m(()=>[x(g(a.$t("common.clear")),1)]),_:1})])):E("",!0),s("div",{class:"h-[180px] w-full overflow-hidden rounded-sm border border-gray-400/20 flex justify-center items-center cursor-pointer",onClick:l[3]||(l[3]=d=>y.value.click())},[e.value.imgSrc?(u(),T(n(ie),{key:0,src:e.value.imgSrc,"object-fit":"contain"},null,8,["src"])):(u(),p("div",Oe,[v(n(C),{type:"primary",size:"small"},{default:m(()=>[x("+"+g(a.$t("dance.character")),1)]),_:1})]))])]),c.value?(u(),p("div",je,[s("div",Ge,[s("div",Te,[v(n(C),{strong:"",secondary:"",round:"",size:"small",type:"success",onClick:l[4]||(l[4]=d=>b(1))},{default:m(()=>[x(g(a.$t("common.clear")),1)]),_:1})]),s("div",Me,[s("video",{controls:"",playsinline:"",loop:"",poster:c.value.processedCoverURL,class:"rounded-lg bg-[#242424] object-contain w-full h-full transition-all",src:c.value.processedURL},null,8,qe)])])])):e.value.vgSrc?(u(),p("div",Ue,[s("div",Fe,[s("div",Ne,[v(n(C),{strong:"",secondary:"",round:"",size:"small",type:"success",onClick:l[5]||(l[5]=d=>b(3))},{default:m(()=>[x(g(a.$t("common.clear")),1)]),_:1})]),s("div",Ke,[s("video",{controls:"",playsinline:"",loop:"",poster:e.value.vgCoverURL,class:"rounded-lg bg-[#242424] object-contain w-full h-full transition-all",src:e.value.vgSrc},null,8,Be)])])])):(u(),p("div",He,[s("input",{type:"file",onChange:q,ref_key:"vsRef",ref:D,style:{display:"none"},accept:".mp4"},null,544),s("div",Pe,[s("div",Ae,[s("div",{class:"cursor-pointer p-2",onClick:X},g(a.$t("dance.upvideo")),1),v(n(C),{type:"primary",size:"small",onClick:l[6]||(l[6]=d=>e.value.showImg=!0)},{default:m(()=>[x(g(a.$t("dance.usevideo")),1)]),_:1})])])])),n(U)?(u(),p("div",Ye,[v(n(F),{value:e.value.version,"onUpdate:value":l[7]||(l[7]=d=>e.value.version=d),options:ee,size:"small"},null,8,["value"])])):E("",!0),s("div",Je,[v(n(C),{block:"",loading:e.value.isDo,type:"primary",disabled:!n(z),onClick:l[8]||(l[8]=d=>I())},{default:m(()=>[v(n(K),{icon:"ri:video-add-line"}),x(" "+g(a.$t("video.generate")),1)]),_:1},8,["loading","disabled"])]),s("div",{class:"pt-4 text-[12px]",innerHTML:n($)("dance.info")},null,8,Qe)]),v(n(ve),{show:e.value.showImg,"onUpdate:show":l[14]||(l[14]=d=>e.value.showImg=d),placement:n(i)?"bottom":"right",class:ue(n(i)?["!h-[90vh]"]:["!w-[80vw]"]),style:{"--n-body-padding":"0"}},{default:m(()=>[v(n(re),{class:"mydrawer",closable:n(i)},{header:m(()=>[s("div",We,[s("div",Xe,g(a.$t("dance.moban")),1),s("div",Ze,[v(n(de),{round:"",placeholder:n($)("dance.moban2"),clearable:"",value:e.value.q,"onUpdate:value":l[10]||(l[10]=d=>e.value.q=d),onKeydown:l[11]||(l[11]=ce(d=>k(),["enter"]))},{prefix:m(()=>[v(n(K),{icon:"uil:search"})]),suffix:m(()=>[s("div",{class:"cursor-pointer",onClick:l[9]||(l[9]=d=>k())},g(a.$t("mjchat.search")),1)]),_:1},8,["placeholder","value"])])])]),default:m(()=>[v(Ve,{q:e.value.q,onToq:l[12]||(l[12]=d=>e.value.q=d.q),onClose:l[13]||(l[13]=d=>e.value.showImg=!1)},null,8,["q"])]),_:1},8,["closable"])]),_:1},8,["show","placement","class"])],64))}}),tt={key:0,class:"p-4"},st={class:"grid grid-cols-1 gap-5 md:grid-cols-2 lg:grid-cols-3"},at=["onMousemove"],lt={class:"relative flex items-center justify-center bg-white bg-opacity-10 rounded-[16px] overflow-hidden aspect-[16/8.85]"},ot=["poster","controls"],nt=["src"],it={key:1,class:"text-center"},rt={key:1,class:"pt-2"},dt={class:"flex justify-between items-center"},ct={class:"line-clamp-1"},ut={class:"max-w-[300px]"},vt={class:"flex justify-end items-center pt-1"},pt={key:1,class:"w-full h-full flex justify-center items-center"},ft=M({__name:"dcList",setup(o){const t=S({pIndex:-1}),e=S([]),c=new Q,y=()=>{let r=c.getObjs();e.value=r.reverse()},D=async r=>{const i=document.createElement("a");i.href=r.result,i.download=r.taskID+".mp4",i.target="_blank",i.rel="noreferrer",document.body.appendChild(i),i.click(),document.body.removeChild(i)};return j(()=>f.myData.act,r=>{r=="FeedViggleTask"&&y()}),y(),(r,i)=>e.value.length>0?(u(),p("div",tt,[s("div",st,[(u(!0),p(G,null,N(e.value,(_,h)=>(u(),p("div",{key:h,class:"relative",onMousemove:I=>t.value.pIndex=h,onMouseout:i[0]||(i[0]=I=>t.value.pIndex=-1)},[s("div",lt,[_.result?(u(),p("video",{key:0,class:"bg-[#242424] object-contain w-full h-full transition-all",referrerpolicy:"no-referrer",poster:_.resultCover,loop:"",playsinline:"",controls:t.value.pIndex==h},[t.value.pIndex==h?(u(),p("source",{key:0,src:_.result,referrerpolicy:"no-referrer",type:"video/mp4"},null,8,nt)):E("",!0)],8,ot)):(u(),p("div",it,[!_.last_feed||new Date().getTime()-_.last_feed>20*1e3?(u(),T(n(C),{key:0,size:"small",type:"primary",onClick:I=>n(W)(_.taskID)},{default:m(()=>[x(g(r.$t("video.repeat")),1)]),_:2},1032,["onClick"])):(u(),p("div",rt,[s("div",null,g(r.$t("video.process"))+g(new Date(_.last_feed).toLocaleString()),1)]))]))]),s("div",dt,[s("div",null,[v(n(fe),{trigger:"hover"},{trigger:m(()=>[s("div",ct,g(_.taskID),1)]),default:m(()=>[s("div",ut,g(_.taskID),1)]),_:2},1024)]),s("div",vt,[v(n(ge),{size:"tiny"},{default:m(()=>[v(n(C),{size:"tiny",round:"",ghost:"",onClick:I=>D(_)},{default:m(()=>[v(n(K),{icon:"mdi:download"}),x(" "+g(r.$t("video.download")),1)]),_:2},1032,["onClick"])]),_:2},1024)])])],40,at))),128))])])):(u(),p("div",pt,[v(n(me),{description:"请先创作才有跳舞视频列表"})]))}}),mt={class:"flex w-full h-full"},gt={class:"w-[300px] h-full overflow-y-auto"},yt={class:"flex-1 h-full bg-[#fafbfc] pt-2 dark:bg-[#18181c] overflow-y-auto"},bt=M({__name:"dance",setup(o){return(t,e)=>(u(),p("div",mt,[s("div",gt,[v(et)]),s("div",yt,[v(ft)])]))}});export{bt as default};
